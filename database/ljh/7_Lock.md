# 21.01.17



## 주요 질문



#### 💡 [Lock이란 무엇인가요?](#Lock)

```markdown
Lock이란 트랜잭션 처리의 순차성을 보장하기 위한 방법으로 데이터베이스의 영속성을 유하기 위해 사용합니다.
```



#### 💡 [Lock의 종류는 무엇이 있나요?](#Lock의-종류)

* 공유(Shared) Lock 과 배타(Exclusive) Lock이 있습니다.

#### 💡 [Blocking이란 무엇인가요?](#블로킹(Blocking))

* 블로킹은 Lock간(배타-배타, 배타-공유)의 경합이 발생하여 특정 Transaction이 작업을 진행하지 못하고 멈춰선 상태를 말합니다.
  공유락 끼리는 블로킹이 발생하지 않지만 배타락은 블로킹을 발생 시킵니다.

💡 [Blocking의 해결방법은?](#블로킹(Blocking)-해결방법)

* 블로킹을 해소하기 위해서는 이전의 트랜잭션이 완료(Commit || Rollback)되어야 합니다. 뒤에 들어온 트랜잭션은 이전 트랜잭션이 마무리 되어야 이후 진행이 가능합니다. 이런 경합은 성능에 좋지 않은 영향을 미칩니다. 따라서 경합을 최소화할 필요가 있습니다.
* 자세한 해결방법은 밑에서 다룹니다.

<br />

## ⭐ 개념 정리

### Lock

```
Lock이란 트랜잭션 처리의 순차성을 보장하기 위한 방법입니다.
DBMS마다 Lock을 구현하는 방식과 세부적인 방법이 다릅니다. 따라서 DBMS를 효과적으로 이용하기 위해서는 해당 DB의 Lock에 대한 이해가 필요.

Lock은 데이터베이스의 영속성을 유지하기 위해 사용된다.
거대한 데이터베이스 시스템은 여러 곳에서 동시에 접근할 수 밖에 없는 구조로 되어 있습니다. 동시에 접근하는 경우 필연적으로 데이터가 오염 될 가능성이 있습니다. 데이터베이스는 데이터의 일관성과 무결성을 유지하기 위해 Lock을 사용하게 됩니다. Lock을 사용함으로써 여러 유저가 동시에 접근하더라도 1명씩 요청을 처리되도록 합니다.
```

<br />

### Lock의 종류

```
Lock의 종류로는 공유(Shared) Lock과 배타(Exclusive) Lock이 있습니다.
공유락은 다른말로 Read Lock이라고 불리며, 배타락은 Write Lock이라고도 불립니다.
```

1. 공유(Shared) Lock

* 공유 Lock은 데이터를 읽을 때 사용되어지는 Lock입니다. 이런 공유 Lock은 공유 Lock끼리는 동시에 접근이 가능합니다.
  데이터베이스의 주요 기능인 데이터 일관성과 무결성을 해치지 않기 때문입니다.
* 즉, 하나의 데이터를 읽는 것은 여러 사용자가 동시에 할 수 있다라는 것입니다.
* 하지만 공유 Lock이 설정된 데이터에 배타 Lock을 사용할 수는 없습니다.

2. 배타(Exclusive) Lock

   * 배타 Lock은 데이터를 변경하고자 할 때 사용되며, 트랜잭션이 완료될 때까지 유지됩니다.
   * 배타 Lock이 해제될 때까지 다른 트랜잭션(읽기 포함)은 해당 리소스에 접근할 수 없습니다.
   * 또한 해당 Lock은 다른 트랜잭션이 수행되고 있는 데이터에 대해서는 접근하여 함께 Lock을 설정할 수 없습니다.

<br />

### Lock의 설정 범위(Level)

* 데이터 베이스

  > 데이터베이스 범위의 Lock은 전체 데이터베이스를 기준으로 Lock을 하는 것이다. 즉, 1개의 세션만이 DB의 데이터에 접근이 가능하다.
  > 해당 기능은 일반적으로 사용하지 않습니다. 사용하는 때가 있다면 DB의 SW버전을 올린다던지 주요한 DB의 업데이트에 사용합니다.

* 파일

  > 데이터베이스 파일을 기준으로 Lock을 설정합니다. 파일이란 테이블, row 등과 같은 실제 데이터가 쓰여지는 물리적인 저장소입니다.
  >
  > 해당범위의 Lock은 잘 사용되지는 않습니다.

* 테이블

  > 테이블 수준의 Lock은 테이블을 기준으로 Lock을 설정합니다. 이는 테이블의 모든 행을 업데이트 하는 등의 전체 테이블에 영향을 주는 변경을 수행할 때 유용합니다. 즉, DDL(CREATE, ALTER, DROP 등) 구문과 함께 사용되며 DDL Lock이라고도 합니다. 

* 페이지와 블럭

  > 파일의 일부인 페이지와 블록을 기준으로 Lock을 설정합니다. 잘 사용되지는 않습니다.

* 컬럼

  > 컬럼 기준의 Lock은 컬럼을 기준으로 Lock을 설정할 수 있씁니다. 하지만 이 형식은 Lock 설정 및 해제의 리소스가 많이 들기 때문에 일반적으로 사용되지는 않습니다. 지원하는 DBMS도 많지 않습니다.

* 행(Row)

  > 행 수준의 Lock은 1개의 행(Row)를 기준으로 Lock을 설정합니다. DML에 대한 Lock으로 가장 일반적으로 사용하는 Lock입니다.

<br />

### 블로킹(Blocking)

```
블로킹은 Lock간(배타-배타, 배타-공유)의 경합이 발생하여 특정 Transaction이 작업을 진행하지 못하고 멈춰선 상태를 말합니다.
위에 설명했듯이 공유락 끼리는 블로킹이 발생하지 않지만 배타락은 블로킹을 발생 시킵니다. 블로킹을 해소하기 위해서는 이전의 트랜잭션이 완료(Commit || Rollback)되어야 합니다. 뒤에 들어온 트랜잭션은 이전 트랜잭션이 마무리 되어야 이후 진행이 가능합니다. 이런 경합은 성능에 좋지 않은 영향을 미칩니다. 따라서 경합을 최소화할 필요가 있습니다.
```

<img width="580" alt="스크린샷 2022-01-18 오전 9 40 30" src="https://user-images.githubusercontent.com/60912550/149851635-1582203a-7333-486d-932d-77514a431fa6.png">

<br />

### 블로킹(Blocking) 해결 방법

1. SQL문장이 복잡하면 리팩터링을 통해 빠르게 실행되도록 한다.
2. 트랜잭션 처리 시간이 짧으면 경합을 줄일 수 있다. 즉, 트랜잭션 처리시간이 길다면 쪼갠다.
3. 동일 데이터를 동시에 변경하는 작업을 배제합니다. 트랜잭션이 많을 시간에는 대용량 갱신 작업을 자제해야 합니다.
4. 대용량 작업은 2번에서 말한 것처럼 쪼개거나 lock_timeout 설정을 통해 Lock 최대시간을 지정해 줍니다.